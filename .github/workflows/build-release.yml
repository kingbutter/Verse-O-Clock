name: Build & Release (devices)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  # ---- Content repo (where toc.bin / entries.bin / texts.bin live)
  CONTENT_OWNER: kingbutter
  CONTENT_REPO: Verse-O-Clock-Content
  CONTENT_BRANCH: main

  # ---- ESP32 Arduino core index
  ESP32_PACKAGE_INDEX: https://espressif.github.io/arduino-esp32/package_esp32_index.json

  # ---- Default device (used if devices/devices.json is missing)
  DEFAULT_DEVICE_ID: xiao_esp32c3_7p5
  DEFAULT_DEVICE_PATH: devices/xiao_esp32c3_7p5
  # IMPORTANT: Adjust if your Arduino FQBN differs
  DEFAULT_FQBN: esp32:esp32:XIAO_ESP32C3

jobs:
  # ------------------------------------------------------------
  # Build matrix from devices/devices.json (optional)
  # If that file doesn't exist, fall back to DEFAULT_DEVICE_*
  # ------------------------------------------------------------
  matrix:
    runs-on: ubuntu-latest
    outputs:
      include: ${{ steps.mk.outputs.include }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build device matrix
        id: mk
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import json, os
          from pathlib import Path

          default = [{
            "device_id": os.environ["DEFAULT_DEVICE_ID"],
            "device_path": os.environ["DEFAULT_DEVICE_PATH"],
            "fqbn": os.environ["DEFAULT_FQBN"],
          }]

          cfg_path = Path("devices/devices.json")
          if not cfg_path.exists():
            print(f"devices/devices.json not found; using default: {default[0]['device_id']}")
            include = default
          else:
            cfg = json.loads(cfg_path.read_text(encoding="utf-8"))
            include = []
            for d in cfg.get("devices", []):
              include.append({
                "device_id": d["id"],
                "device_path": d["path"],
                "fqbn": d.get("fqbn", os.environ["DEFAULT_FQBN"]),
              })
            if not include:
              include = default

          out = json.dumps(include)
          print(out)
          Path(os.environ["GITHUB_OUTPUT"]).write_text(f"include={out}\n", encoding="utf-8")
          PY

  # ------------------------------------------------------------
  # Build firmware + generate verse blobs (toc.bin/entries.bin/texts.bin)
  # ------------------------------------------------------------
  build:
    needs: matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.matrix.outputs.include) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Install ESP32 core
        shell: bash
        run: |
          set -euo pipefail
          arduino-cli config init
          arduino-cli config set board_manager.additional_urls "${ESP32_PACKAGE_INDEX}"
          arduino-cli core update-index
          arduino-cli core install esp32:esp32

      - name: Install Arduino libraries
        shell: bash
        run: |
          set -euo pipefail
          # Common libs (add/remove as needed)
          arduino-cli lib update-index
          arduino-cli lib install "ArduinoJson" || true
          arduino-cli lib install "WiFiManager" || true

          # Unishox (siara-cc) â€” clone into Arduino/libraries to be safe
          mkdir -p "$HOME/Arduino/libraries"
          if [ ! -d "$HOME/Arduino/libraries/Unishox_Arduino_lib" ]; then
            git clone --depth 1 https://github.com/siara-cc/Unishox_Arduino_lib.git "$HOME/Arduino/libraries/Unishox_Arduino_lib"
          fi

      - name: Generate verse content (toc/entries/texts)
        shell: bash
        run: |
          set -euo pipefail
          # ---- Adjust this command to match how you run it locally ----
          # Goal: produce toc.bin, entries.bin, texts.bin in the device data folder.
          #
          # Typical target folder:
          #   ${{ matrix.device_path }}/data/
          #
          DATA_DIR="${{ matrix.device_path }}/data"
          mkdir -p "${DATA_DIR}"

          # If your helper already writes into the device data folder by default,
          # you can keep it simple:
          python3 helpers/build_verses_unishox.py

          # If your helper writes somewhere else, copy the outputs into DATA_DIR here.

      - name: Build firmware (arduino-cli)
        shell: bash
        run: |
          set -euo pipefail
          # Find the ino file inside the device folder
          INO="$(ls -1 "${{ matrix.device_path }}"/*.ino | head -n 1)"
          if [ -z "${INO}" ]; then
            echo "No .ino found under ${{ matrix.device_path }}"
            exit 1
          fi

          mkdir -p dist/${{ matrix.device_id }}

          arduino-cli compile             --fqbn "${{ matrix.fqbn }}"             --output-dir "dist/${{ matrix.device_id }}/build"             "${INO}"

          # Copy the compiled app bin(s) into dist
          find "dist/${{ matrix.device_id }}/build" -maxdepth 1 -type f -name "*.bin" -exec cp -v {} "dist/${{ matrix.device_id }}/" \;

      - name: Create manifest.json (sizes + sha256)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import hashlib, json
          from pathlib import Path

          data_dir = Path("${{ matrix.device_path }}/data")
          files = ["toc.bin", "entries.bin", "texts.bin"]
          manifest = {"device": "${{ matrix.device_id }}", "files": {}}

          for name in files:
            p = data_dir / name
            if not p.exists():
              raise SystemExit(f"Missing required content file: {p}")
            b = p.read_bytes()
            manifest["files"][name] = {
              "size": len(b),
              "sha256": hashlib.sha256(b).hexdigest(),
            }

          out = data_dir / "manifest.json"
          out.write_text(json.dumps(manifest, indent=2), encoding="utf-8")
          print(f"Wrote {out}")
          PY

      - name: Collect content artifacts
        shell: bash
        run: |
          set -euo pipefail
          DATA_DIR="${{ matrix.device_path }}/data"
          mkdir -p "dist/${{ matrix.device_id }}/content"
          cp -v "${DATA_DIR}/toc.bin" "dist/${{ matrix.device_id }}/content/"
          cp -v "${DATA_DIR}/entries.bin" "dist/${{ matrix.device_id }}/content/"
          cp -v "${DATA_DIR}/texts.bin" "dist/${{ matrix.device_id }}/content/"
          cp -v "${DATA_DIR}/manifest.json" "dist/${{ matrix.device_id }}/content/"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.device_id }}
          path: dist/${{ matrix.device_id }}
          if-no-files-found: error

  # ------------------------------------------------------------
  # Release (on tag): attach firmware artifacts to a GitHub Release
  # ------------------------------------------------------------
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/**/*.bin
            artifacts/**/content/*.bin
            artifacts/**/content/manifest.json

  # ------------------------------------------------------------
  # Publish content to Verse-O-Clock-Content repo (on tag)
  # Copies toc/entries/texts/manifest into the CONTENT repo root.
  # ------------------------------------------------------------
  publish_content:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Checkout content repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CONTENT_OWNER }}/${{ env.CONTENT_REPO }}
          ref: ${{ env.CONTENT_BRANCH }}
          token: ${{ secrets.CONTENT_REPO_TOKEN }}
          path: contentrepo

      - name: Copy content files into content repo
        shell: bash
        run: |
          set -euo pipefail
          # For now, publish the DEFAULT_DEVICE_ID content (simple & safe).
          # If you later have multiple devices, we can publish per-device folders.
          SRC="artifacts/firmware-${DEFAULT_DEVICE_ID}/content"
          if [ ! -d "${SRC}" ]; then
            echo "Expected content at ${SRC}, but it doesn't exist."
            echo "Artifacts tree:"
            find artifacts -maxdepth 4 -type d -print
            exit 1
          fi

          cp -v "${SRC}/toc.bin" contentrepo/
          cp -v "${SRC}/entries.bin" contentrepo/
          cp -v "${SRC}/texts.bin" contentrepo/
          cp -v "${SRC}/manifest.json" contentrepo/

      - name: Commit & push
        shell: bash
        working-directory: contentrepo
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add toc.bin entries.bin texts.bin manifest.json
          if git diff --cached --quiet; then
            echo "No content changes to publish."
            exit 0
          fi

          git commit -m "Update Verse-O-Clock content for ${GITHUB_REF_NAME}"
          git push
